<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">


<dom-module id="todo-app">
    <template>
    <style>
    .container{
		@apply(--layout-horizontal);
		@apply(--layout-wrap);
    }
    .flexchild {
        @apply(--layout-flex);
        -webkit-flex: 1 0 200px; /* hack for safari */
    }
    paper-toolbar {
        --paper-toolbar-background: var(--paper-orange-400);
    }
    paper-card {
        width: 100%;
        color: white;
        box-sizing: border-box;
        margin: 4px;
        flex: 0 0 auto;
        --paper-card-header-color: white;
        --paper-card-background-color: var(--paper-cyan-400);
    }
    paper-card[done]{
        --paper-card-background-color: var(--paper-cyan-100);
    }
    paper-card[priority]{
        --paper-card-background-color: var(--paper-cyan-800);
    }
    span[done]{
      text-decoration: line-through;
    }
    </style>

    <paper-toolbar>
        <paper-icon-button icon="menu"></paper-icon-button>
        <span class="title">TodoSlacker</span>
    </paper-toolbar>

	<div class="container">
    <template is="dom-repeat" items="[[reply.tickets]]" as="ticket">
    <paper-card done$={{ticket.end_time}} priority$={{ticket.priority}} heading="{{ticket.id}}" class="flexchild">
		<div class="card-content">
        <span done$={{ticket.end_time}}> {{ticket.detail}} </span>
        <ol>
          <template is="dom-repeat" items="{{ticket.todos}}" as="todo">
          <li><span done$={{todo.done}}> {{todo.item}} </span> </li>
          </template>
        </ol>
      	</div>
		<div class="card-actions"> 
          {{_timeLapsed(ticket.start_time, ticket.end_time)}} 
		</div>
    </paper-card>
    </template>
	</div>

    <iron-ajax
      auto
      id="requestData"
      url="/data"
      handleAs="json"
      on-response="handleResponse">
    </iron-ajax>
  </template>

  <script>
    Polymer({
      is: "todo-app",
      properties: {
        reply: {
          type: Object
        }
      },
      handleResponse: function (data){
        this.reply=data.detail.response;
      },
      _timeLapsed: function (start_time, end_time){
        var time = end_time == null? Date.now() : Date.parse(end_time);
        var icon = end_time == null? "\u231B" : "\u2714 done on ";
        var days = Math.floor((time - Date.parse(start_time))/86400000);
        return icon + " day " + days;
      }
    });
  </script>
</dom-module>
